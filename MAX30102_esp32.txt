#include <Arduino.h>
#include <Wire.h>
#include <MAX30105.h>
#include "heartRate.h"

MAX30105 sensor;

long lastBeat = 0;
int beatAvg = 0;
int beatsPerMin = 0;

void setup() {
    Serial.begin(115200);
    delay(1000);

    Wire.begin();

    Serial.println("Mencari MAX30102...");

    if (!sensor.begin(Wire, I2C_SPEED_FAST)) {
        Serial.println("Sensor MAX30102 tidak ditemukan!");
        while (1);
    }

    sensor.setup();
    sensor.setPulseAmplitudeRed(0x0A);
    sensor.setPulseAmplitudeGreen(0x00);

    Serial.println("MAX30102 siap. Mulai membaca data...");
}

void loop() {
    long irValue = sensor.getIR();

    if (irValue < 50000) {
        Serial.println("Letakkan jari di sensor...");
        delay(100);
        return;
    }

    if (checkForBeat(irValue)) {
        long delta = millis() - lastBeat;
        lastBeat = millis();
        beatsPerMin = 60 / (delta / 1000.0);

        if (beatsPerMin < 40 || beatsPerMin > 180) {
            beatsPerMin = 0;
        }
    }

    beatAvg = (beatAvg * 0.9) + (beatsPerMin * 0.1);

    Serial.print("IR: ");
    Serial.print(irValue);
    Serial.print(" | BPM: ");
    Serial.print(beatsPerMin);
    Serial.print(" | Avg BPM: ");
    Serial.println(beatAvg);

    delay(10);
}
